name: Issue Automation
on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:

jobs:
  setup-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Required Labels
        uses: actions/github-script@v7
        with:
          script: |
            const labelsToCreate = [
              { name: 'bug', color: 'd73a4a', description: 'Something isn\'t working' },
              { name: 'enhancement', color: 'a2eeef', description: 'New feature or request' },
              { name: 'epic', color: '0052cc', description: 'Large feature requiring multiple sub-tasks' },
              { name: 'maintenance', color: 'fef2c0', description: 'Maintenance and housekeeping tasks' },
              { name: 'priority-critical', color: 'b60205', description: 'Critical priority issue' },
              { name: 'priority-high', color: 'ff9f1c', description: 'High priority issue' },
              { name: 'priority-medium', color: 'ffff00', description: 'Medium priority issue' },
              { name: 'priority-low', color: '0e8a16', description: 'Low priority issue' },
              { name: 'needs-triage', color: 'fbca04', description: 'Needs to be reviewed by maintainers' },
              { name: 'needs-review', color: '1d76db', description: 'Awaiting review from maintainers' },
              { name: 'first-time-contributor', color: '28a745', description: 'Issue created by first-time contributor' }
            ];
            
            for (const label of labelsToCreate) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
              } catch (err) {
                if (err.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color.replace('#', ''),
                    description: label.description
                  });
                }
              }
            }

  issue-triage:
    runs-on: ubuntu-latest
    needs: setup-labels
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Triage Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);
            const title = issue.title.toLowerCase();
            const body = issue.body.toLowerCase();
            
            if (!labels.includes('needs-triage')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-triage']
              });
            }
            
            const categoryLabels = [];
            if (title.includes('bug')) categoryLabels.push('bug');
            if (title.includes('epic')) categoryLabels.push('epic');
            if (title.includes('maintenance')) categoryLabels.push('maintenance');
            
            if (categoryLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: categoryLabels
              });
            }
            
            const priorityKeywords = {
              'priority-critical': ['critical', 'urgent', 'production', 'outage'],
              'priority-high': ['important', 'high', 'blocking'],
              'priority-medium': ['medium', 'normal'],
              'priority-low': ['low', 'nice-to-have', 'minor']
            };
            
            let priorityLabel = 'priority-medium';
            for (const [label, keywords] of Object.entries(priorityKeywords)) {
              if (keywords.some(k => title.includes(k) || body.includes(k))) {
                priorityLabel = label;
                break;
              }
            }
            
            if (!labels.includes(priorityLabel)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [priorityLabel]
              });
            }

  task-breakdown:
    runs-on: ubuntu-latest
    needs: issue-triage
    if: contains(github.event.issue.title, 'Epic')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Sub-Issues
        uses: actions/github-script@v7
        with:
          script: |
            const parent = context.payload.issue;
            const tasks = ['Requirements Analysis', 'Design and Architecture', 'Implementation', 'Testing and Documentation'];
            
            const subIssues = await Promise.all(tasks.map(async (task, idx) => {
              const title = `[SUBTASK] ${parent.title} - Task ${idx+1}: ${task}`;
              const body = `Related to #${parent.number}`;
              return github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['enhancement', 'needs-review']
              });
            }));
            
            const checklist = subIssues.map((sub, idx) => `- [ ] Task ${idx+1}: #${sub.data.number}`).join('\n');
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parent.number,
              body: `${parent.body}\n\n## Epic Tasks\n${checklist}`
            });

  auto-response:
    runs-on: ubuntu-latest
    needs: [issue-triage, task-breakdown]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Auto-Response Logic
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const author = issue.user.login;
            const labels = issue.labels.map(l => l.name);
            
            const contribs = await github.rest.repos.listContributors({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const isFirstTime = !contribs.data.some(c => c.login === author);
            
            if (isFirstTime) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['first-time-contributor']
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Welcome @${author}! Thank you for your first issue. We'll review it soon.`
              });
            }
            
            let comment = '';
            if (labels.includes('bug')) comment = 'Bug Report Guidelines: Please ensure you have provided steps to reproduce and environment details.';
            if (labels.includes('epic')) comment = 'Feature Request Process: We will review your epic and break it into subtasks shortly.';
            if (labels.includes('maintenance')) comment = 'Maintenance Guidelines: Thank you for reporting this task. We will prioritize it soon.';
            
            if (comment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: comment
              });
            }
            
            const milestones = await github.rest.issues.listMilestones({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            const v1Milestone = milestones.data.find(m => m.title === 'v1.0.0');
            
            if (v1Milestone && (labels.includes('priority-high') || labels.includes('priority-critical'))) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                milestone: v1Milestone.number
              });
            }
            
            if (labels.includes('needs-triage')) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'needs-triage'
              });
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-review']
              });
            }
